<dom-module id="sr-add-page-card">
  <template>
    <style include="shared-styles">
      .top-padded {
        margin-top: 20px;
      }

      .selected-item {
        width: 100%;
        background-color: var(--paper-indigo-500);
        color: white;
        height: 47px;
        line-height: 47px;
        margin: 8px 0;
        border-radius: 47px;
      }

      .selected-item span {
        padding: 0 23.5px;
        font-weight: 500;
      }

      .selected-item paper-icon-button {
        float: right;
        margin: 3.5px;
      }

      paper-radio-group {
        margin: 20px;
      }
    </style>
    <!-- <paper-radio-group selected="{{creationAction}}">
      <paper-radio-button name="link">Bind to an existing page</paper-radio-button>
      <paper-radio-button name="new">Create a new page</paper-radio-button>
    </paper-radio-group> -->
    <!-- <template is="dom-if" if="[[shouldCreateNewPage(creationAction)]]"> -->
    <paper-card>
      <app-toolbar>
        <div main-title>Create a new page</div>
      </app-toolbar>
      <div class="card-content">
        <paper-dropdown-menu label="Page Type">
          <paper-listbox slot="dropdown-content" class="dropdown-content">
            <template is="dom-repeat" items="{{pageTypes}}">
              <paper-item>{{item}}</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
        <!-- <paper-input
            label="New Page Title"
            required></paper-input> -->
        <template is="dom-if" if="[[!pageSearchResult.text]]">
          <paper-autocomplete
              id="pageSearchInput"
              label="Search for Page"
              required
              remote-source
              show-results-on-focus></paper-autocomplete>
        </template>
        <template is="dom-if" if="[[pageSearchResult.text]]">
          <div class="selected-item">
            <span>{{pageSearchResult.text}}</span>
            <paper-icon-button icon="sr-icons:close" on-tap="clearPageSearchResult"></paper-icon-button>
          </div>
        </template>
        <paper-textarea label="Summary"></paper-textarea>
      </div>
      <div class="card-actions">
        <paper-toggle-button
            class="top-padded"
            checked="{{linkToPreviousPage}}">Link to previous page</paper-toggle-button>
        <paper-autocomplete
            label="Linked Page"
            required
            text="{{linkedPageText}}"
            value="{{linkedPageValue}}"
            disabled="[[linkToPreviousPage]]"
            show-results-on-focus></paper-autocomplete>
      </div>
    </paper-card>
    <!-- </template> -->
    <!-- <template is="dom-if" if="[[!shouldCreateNewPage(creationAction)]]">
      <paper-card>
        <app-toolbar>
          <div main-title>Bind to an existing page</div>
        </app-toolbar>
        <div class="card-content">
          <template is="dom-if" if="[[!pageSearchResult.text]]">
            <paper-autocomplete
                id="pageSearchInput"
                label="Search for Page"
                required
                remote-source
                show-results-on-focus></paper-autocomplete>
          </template>
          <template is="dom-if" if="[[pageSearchResult.text]]">
            <div class="selected-item">
              <span>{{pageSearchResult.text}}</span>
              <paper-icon-button icon="sr-icons:close" on-tap="clearPageSearchResult"></paper-icon-button>
            </div>
          </template>
        </div>
      </paper-card>
    </template> -->
  </template>

  <script>
    class SrAddPageCard extends Polymer.Element {
      static get is() { return 'sr-add-page-card'; }

      static get properties() {
        return {
          linkToPreviousPage: {
            type: Boolean,
            value: true
          },
          linkedPageText: {
            type: String,
            value: null
          },
          linkedPageValue: {
            type: String,
            value: null
          },
          pageTypes: {
            type: Array,
            value: []
          },
          searchPageParams: {
            type: Object,
            value: {}
          },
          pageSearchResult: {
            type: Object,
            value: {}
          }
        };
      }

      static get observers() {
        return [
          '_linkToPreviousPageChanged(linkToPreviousPage)',
        ];
      }

      constructor() {
        super();
        this._setLinkedPageDefaults();
        this._setPageTypes();
        // this.$.pageSearchInput.queryFn = this.searchQueryResults;
        // var newSearch = this.searchQueryResults();
        // this.set('titleSearches', newSearch);
      }

      ready() {
        super.ready();
        this.addEventListener('autocomplete-change', e => this._autocompleteChangeListener(e));
        this.addEventListener('autocomplete-selected', e => this._autocompleteSelectedListener(e));
      }

      _autocompleteChangeListener(event) {
        this._retrieveTitlePageSearchResults(event.detail.text);
      }

      _autocompleteSelectedListener(event) {
        this.set('pageSearchResult', {
          value: event.detail.value,
          text: event.detail.text
        }); 
      }

      clearPageSearchResult() {
        this.set('pageSearchResult', {});
      }

      _retrieveTitlePageSearchResults(searchQuery) {
        if (!searchQuery || searchQuery.length < 2) {
          this._setSearchSuggestions([]);
          return;
        }
        var params = {
          query: searchQuery,
          type: 'CH'
        };
        this.set('searchPageParams', params);
        this.$.getSearchPageResultsAjax.params = params;
        this.$.getSearchPageResultsAjax.generateRequest();
      }

      handleSearchPageResults(event) {
        var searchResults = [];
        event.detail.response.forEach(function(result) {
          searchResults.push({
            text: result.name,
            value: result.id
          });
        });
        this._setSearchSuggestions(searchResults);
      }

      _setSearchSuggestions(searchResults) {
        var paperSearchInput = this.shadowRoot.querySelector("#" + "pageSearchInput");
        if (!paperSearchInput) {
          return;
        }
        paperSearchInput.suggestions(searchResults);
      }

      _linkToPreviousPageChanged(linkToPreviousPage) {
        if (linkToPreviousPage) {
          this._setLinkedPageDefaults();
        }
      }

      _setLinkedPageDefaults() {
        if (!this.page) {
          console.log('@DEBUG: page not found. Remove check after debugging.');
          return;
        }
        console.log('@DEBUG: page found. Remove check after debugging.');
        this.set('linkedPageText', this.page.name);
        this.set('linkedPageValue', this.page.id);
      }

      _setPageTypes() {
        this.set('pageTypes', [
          'Association',
          'Campaign',
          'Character',
          'District',
          'Era',
          'Event',
          'Group',
          'History',
          'Item',
          'Landmark',
          'Lore',
          'Place',
          'Quest',
          'Race',
          'Region',
          'Report',
          'Section',
          'Set',
          'Species',
          'Story arc',
          'Taxon',
          'World',
        ]);
      }
    }

    window.customElements.define(SrAddPageCard.is, SrAddPageCard);
  </script>
</dom-module>
