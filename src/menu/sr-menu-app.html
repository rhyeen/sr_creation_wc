<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">


<!-- <link rel="import" href="../../bower_components/web-animations-js/web-animations-next-lite.min.js"> -->
<link rel="import" href="../../bower_components/neon-animation/web-animations.html">

<link rel="import" href="../tools/sr-icons.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../material-styles/typography.html">
<link rel="import" href="../material-styles/shadow.html">
<link rel="import" href="../material-styles/default-theme.html">
<link rel="import" href="../material-styles/color.html">

<link rel="lazy-import" href="../account/sr-account-app.html">
<link rel="lazy-import" href="../page/sr-page-app.html">
<link rel="lazy-import" href="../page/sr-edit-page-content-view.html">
<link rel="lazy-import" href="../settings/sr-settings-app.html">
<link rel="lazy-import" href="../bookmark/sr-bookmark-app.html">

<dom-module id="sr-menu-app">
  <template>
    <style include="shared-styles">
      :host {
        --app-primary-color: #373737;
        display: block;
      }

      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }

      app-header {
        color: #fff;
        background-color: var(--app-primary-color);
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }
    </style>

    <app-location route="{{route}}"></app-location>
    <app-route
        route="{{route}}"
        pattern="/:viewWindow"
        data="{{routeData}}"
        tail="{{subRoute}}"></app-route>
    <app-drawer-layout fullbleed narrow="{{narrow}}">
      <!-- Drawer content -->
      <app-drawer id="drawer" slot="drawer" swipe-open="[[narrow]]">
        <app-toolbar>
          <div main-title>Main Menu</div>
          <paper-icon-button icon="sr-icons:close" drawer-toggle></paper-icon-button>
        </app-toolbar>
        <iron-selector selected="{{routeData.viewWindow}}" attr-for-selected="name" class="drawer-list" role="navigation">
          <paper-icon-item name="page">
            <iron-icon icon="sr-icons:description" slot="item-icon"></iron-icon>
            Pages
          </paper-icon-item>
<!--           <paper-icon-item name="editPage">
            <iron-icon icon="sr-icons:description" slot="item-icon"></iron-icon>
            Edit Page
          </paper-icon-item> -->
          <paper-icon-item name="bookmark">
            <iron-icon icon="sr-icons:bookmark" slot="item-icon"></iron-icon>
            Bookmarks
          </paper-icon-item>
          <paper-icon-item name="account">
            <iron-icon icon="sr-icons:account-circle" slot="item-icon"></iron-icon>
            Account
          </paper-icon-item>
          <paper-icon-item name="settings">
            <iron-icon icon="sr-icons:settings" slot="item-icon"></iron-icon>
            Settings
          </paper-icon-item>
        </iron-selector>
      </app-drawer>

      <!-- Main content -->
      <app-header-layout has-scrolling-region>

        <app-header slot="header" condenses reveals effects="waterfall">
          <app-toolbar>
            <paper-icon-button icon="sr-icons:menu" drawer-toggle></paper-icon-button>
            <div main-title>SR Creation</div>
          </app-toolbar>
          <!-- <div class="page-title" sticky>Prophecy of the Bloodmoon God</div> -->
          <app-toolbar class="page-title" sticky>
            <template is="dom-if" if="{{showBackButton}}">
              <paper-icon-button icon="sr-icons:arrow-back" on-tap="goBack"></paper-icon-button>
            </template>
            <div main-title>{{menuTitle}}
            </div>
            <paper-icon-button icon="sr-icons:search" on-tap="toggleSearchDialog"></paper-icon-button>
            <paper-menu-button dynamic-align="true">
              <paper-icon-button icon="sr-icons:more-vert" slot="dropdown-trigger"></paper-icon-button>
              <paper-listbox slot="dropdown-content">
                <template is="dom-repeat" items="{{menuItems}}">
                  <paper-icon-item>
                    <iron-icon icon="sr-icons:{{item.icon}}" slot="item-icon"></iron-icon>
                    {{item.title}}
                  </paper-icon-item>
                </template>
                <!-- <paper-icon-item name="deletePage">
                  <iron-icon icon="sr-icons:delete" slot="item-icon"></iron-icon>
                  Delete page
                </paper-icon-item> -->
              </paper-listbox>
            </paper-menu-button>
          </app-toolbar>
        </app-header>

        <iron-pages
            selected="[[routeData.viewWindow]]"
            attr-for-selected="name"
            fallback-selection="page"
            role="main">
          <sr-page-app name="page" route="{{subRoute}}"></sr-page-app>
          <!-- <sr-edit-page-content-view name="editPage"></sr-edit-page-content-view> -->
          <sr-bookmark-app name="bookmark"></sr-bookmark-app>
          <sr-account-app name="account"></sr-account-app>
          <sr-settings-app name="settings"></sr-settings-app>
        </iron-pages>
      </app-header-layout>
    </app-drawer-layout>
    <paper-dialog id="searchDialog" modal>
      <h2>Header</h2>
      <paper-dialog-scrollable>
        Lorem ipsum...
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>Accept</paper-button>
      </div>
    </paper-dialog>
  </template>

  <script>
    class SrMenuApp extends Polymer.Element {
      static get is() { return 'sr-menu-app'; }

      static get properties() {
        return {
          menuTitle: {
            type: String,
            value: 'Page'
          },
          menuItems: {
            type: Array,
            value: []
          },
          backPath: {
            type: String,
            value: false
          }
        };
      }

      static get observers() {
        return [
          '_routeChanges(route.path)',
          '_routeDataChanged(routeData.viewWindow)',
        ];
      }

      _routeChanges(path) {
        this._updateMenuTitle(path);
      }

      _updateMenuTitle(path) {
        var pathParts = path.split('/');
        if (pathParts.length == 4) {
          var context = pathParts[3];
          if (context == 'summary') {
            this.set('showBackButton', false);
            this.set('menuItems', [
              {
                title: 'New Page',
                icon: 'page-add'
              },
              {
                title: 'Delete Page',
                icon: 'delete'
              }
            ]);
            return this.set('menuTitle', 'Page Summary');
          }
          if (context == 'detail') {
            this.set('showBackButton', true);
            this.set('menuItems', [
              {
                title: 'New Detail',
                icon: 'add-circle'
              },
              {
                title: 'Reorder Details',
                icon: 'reorder'
              }
            ]);
            return this.set('menuTitle', 'Details');
          }
          if (context == 'image') {
            this.set('showBackButton', true);
            this.set('menuItems', [
              {
                title: 'New Image',
                icon: 'add-circle'
              },
              {
                title: 'Reorder Images',
                icon: 'reorder'
              }
            ]);
            return this.set('menuTitle', 'Images');
          }
        }
        if (pathParts.length == 5) {
          if (pathParts[3] == 'related-pages') {
            var relatedPageType = pathParts[4];
            this.set('showBackButton', true);
            this.set('menuItems', [
              {
                title: this._getRelatedPageAddPageTitle(relatedPageType),
                icon: 'add-circle'
              },
              {
                title: this._getRelatedPageReorderPageTitle(relatedPageType),
                icon: 'reorder'
              }
            ]);
            return this.set('menuTitle', this._getRelatedPageMenuTitle(relatedPageType));
          }
        }
        return this.set('menuTitle', 'Page');
      }

      _getRelatedPageAddPageTitle(relatedPageType) {
        var relatedPageMap = this._getRelatedPageMap(relatedPageType);
        if (!relatedPageMap) {
          return "Add Related Page";
        }
        return "Add " + this._capitalizeFirstLetter(relatedPageMap.singular);
      }

      _getRelatedPageReorderPageTitle(relatedPageType) {
        var relatedPageMap = this._getRelatedPageMap(relatedPageType);
        if (!relatedPageMap) {
          return "Reorder Related Pages";
        }
        return "Reorder " + this._capitalizeFirstLetter(relatedPageMap.plural);
      }

      _getRelatedPageMenuTitle(relatedPageType) {
        var relatedPageMap = this._getRelatedPageMap(relatedPageType);
        if (!relatedPageMap) {
          return "Related Pages";
        }
        return "Related " + this._capitalizeFirstLetter(relatedPageMap.plural);
      }

      _capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }

      /** also in sr-related-pages-view.
          @TODO: add to a single service.
       */
      _getRelatedPageMap(pageType) {
        var map = {
          'AS': {
            plural: 'associations',
            singular: 'association'
          },
          'CA': {
            plural: 'campaigns',
            singular: 'campaign'
          },
          'CH': {
            plural: 'characters',
            singular: 'character'
          },
          'DI': {
            plural: 'districts',
            singular: 'district'
          },
          'EA': {
            plural: 'eras',
            singular: 'era'
          },
          'EV': {
            plural: 'events',
            singular: 'event'
          },
          'GR': {
            plural: 'groups',
            singular: 'group'
          },
          'HI': {
            plural: 'histories',
            singular: 'history'
          },
          'IT': {
            plural: 'items',
            singular: 'item'
          },
          'LM': {
            plural: 'landmarks',
            singular: 'landmark'
          },
          'LR': {
            plural: 'lores',
            singular: 'lore'
          },
          'PL': {
            plural: 'places',
            singular: 'place'
          },
          'QU': {
            plural: 'quests',
            singular: 'quest'
          },
          'RA': {
            plural: 'races',
            singular: 'race'
          },
          'RG': {
            plural: 'regions',
            singular: 'region'
          },
          'RP': {
            plural: 'reports',
            singular: 'report'
          },
          'SE': {
            plural: 'sections',
            singular: 'section'
          },
          'ST': {
            plural: 'sets',
            singular: 'set'
          },
          'SP': {
            plural: 'species',
            singular: 'species'
          },
          'SA': {
            plural: 'story arcs',
            singular: 'story arc'
          },
          'TX': {
            plural: 'taxons',
            singular: 'taxon'
          },
          'WD': {
            plural: 'worlds',
            singular: 'worlds'
          }
        }
        if (!(pageType in map)) {
          return null;
        }
        return map[pageType];
      }

      toggleSearchDialog() {
        this.$.searchDialog.toggle();
      }

      goBack() {
        window.history.back();
      }

      _resolvePage(viewWindow) {
        var validPages = [
          'page',
          'bookmark',
          'account',
          'settings'
        ];
        if (validPages.indexOf(viewWindow) === -1) {
          this.set('routeData.viewWindow', 'page');
          // this.set('route.path', '/page');
          return 'page';
        }
        return viewWindow;
      }

      _routeDataChanged(viewWindow) {
        // console.log('Menu');
        // console.log(this.route);
        // console.log(this.subRoute);
        // Close a non-persistent drawer when the page & route are changed.
        if (!this.$.drawer.persistent) {
          this.$.drawer.close();
        }
        viewWindow = this._resolvePage(viewWindow);
        var resolveUrlMap = {
          page: '../page/sr-page-app.html',
          bookmark: '../bookmark/sr-bookmark-app.html',
          account: '../account/sr-account-app.html',
          settings: '../settings/sr-settings-app.html',
        };
        
        var resolvedPageUrl = this.resolveUrl(resolveUrlMap[viewWindow]);
        Polymer.importHref(
            resolvedPageUrl,
            null,
            null,
            true);
      }
    }

    window.customElements.define(SrMenuApp.is, SrMenuApp);
  </script>
</dom-module>
