<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../shared-styles.html">

<dom-module id="sr-related-pages-view">
  <template>
    <style include="shared-styles">
      .related-pages {
        margin-top: 20px;
      }

      a {
        color: inherit;
        text-decoration: inherit;
      }
    </style>
    <app-route
        route="{{route}}"
        pattern="/:context"
        data="{{routeData}}"
        tail="{{subRoute}}"></app-route>
    <template is="dom-if" if="{{showView}}">
      <paper-card>
        <app-toolbar>
          <div main-title>Related Pages</div>
          <paper-menu-button dynamic-align="true">
            <paper-icon-button icon="sr-icons:more-vert" slot="dropdown-trigger"></paper-icon-button>
            <paper-listbox slot="dropdown-content">
              <paper-icon-item name="page">
                <iron-icon icon="sr-icons:add-circle" slot="item-icon"></iron-icon>
                Add a Related Page
              </paper-icon-item>
              <paper-icon-item name="account">
                <iron-icon icon="sr-icons:reorder" slot="item-icon"></iron-icon>
                Reorder Related Pages
              </paper-icon-item>
            </paper-listbox>
          </paper-menu-button>
        </app-toolbar>
        <template is="dom-if" if="{{showRelatedPages(page)}}">
          <div class="related-pages">
            <template is="dom-repeat" items="{{page.pages}}">
              <a href="{{route.prefix}}/related-pages/{{item.type}}" tabindex="-1">
                <paper-item>
                  <div class="title" id="{{getRelatedPageId(item)}}">[[getRelatedPageName(item)]]</div>
                  <paper-badge for="{{getRelatedPageId(item)}}" label="{{item.properties.list.length}}"></paper-badge>
                </paper-item>
              </a>
            </template>
          </div>
        </template>
      </paper-card>
    </template>
  </template>
  <script>
    class SrRelatedPagesView extends Polymer.Element {
      static get is() { return 'sr-related-pages-view'; }

      static get properties() {
        return {
          showView: Boolean
        };
      }

      static get observers() {
        return [
          '_routeChanged(route.path)',
          '_routeDataChanged(routeData.context)',
        ];
      }

      _routeChanged(path) {
        // if back button is pressed, and routeData.context is going to be null, it won't be: instead it'll stay the same.
        if (!path) {
          this._routeDataChanged(null);
        }
      }

      _routeDataChanged(context) {
        // console.log('Related pages');
        // console.log(this.route);
        // console.log(this.subRoute);
        // if (!context) {
        //   return this.set('routeData.context', 'summary');
        // }
        this.set('showView', !context || context == 'summary');
      }

      showRelatedPages(page) {
        return !!page && !!page.pages && page.pages.length;
      }

      getRelatedPageId(relatedPage) {
        return "relatedPage" + relatedPage.type;
      }

      getRelatedPageName(relatedPage) {
        var relatedPageMap = this._getRelatedPageMap(relatedPage.type);
        if (!relatedPageMap) {
          return null;
        }
        return relatedPageMap.plural;
      }

      /** also in sr-menu-app.
          @TODO: add to a single service.
       */
      _getRelatedPageMap(pageType) {
        var map = {
          'AS': {
            plural: 'associations',
            singular: 'association'
          },
          'CA': {
            plural: 'campaigns',
            singular: 'campaign'
          },
          'CH': {
            plural: 'characters',
            singular: 'character'
          },
          'DI': {
            plural: 'districts',
            singular: 'district'
          },
          'EA': {
            plural: 'eras',
            singular: 'era'
          },
          'EV': {
            plural: 'events',
            singular: 'event'
          },
          'GR': {
            plural: 'groups',
            singular: 'group'
          },
          'HI': {
            plural: 'histories',
            singular: 'history'
          },
          'IT': {
            plural: 'items',
            singular: 'item'
          },
          'LM': {
            plural: 'landmarks',
            singular: 'landmark'
          },
          'LR': {
            plural: 'lores',
            singular: 'lore'
          },
          'PL': {
            plural: 'places',
            singular: 'place'
          },
          'QU': {
            plural: 'quests',
            singular: 'quest'
          },
          'RA': {
            plural: 'races',
            singular: 'race'
          },
          'RG': {
            plural: 'regions',
            singular: 'region'
          },
          'RP': {
            plural: 'reports',
            singular: 'report'
          },
          'SE': {
            plural: 'sections',
            singular: 'section'
          },
          'ST': {
            plural: 'sets',
            singular: 'set'
          },
          'SP': {
            plural: 'species',
            singular: 'species'
          },
          'SA': {
            plural: 'story arcs',
            singular: 'story arc'
          },
          'TX': {
            plural: 'taxons',
            singular: 'taxon'
          },
          'WD': {
            plural: 'worlds',
            singular: 'worlds'
          }
        }
        if (!(pageType in map)) {
          return null;
        }
        return map[pageType];
      }
    }

    window.customElements.define(SrRelatedPagesView.is, SrRelatedPagesView);
  </script>
</dom-module>
