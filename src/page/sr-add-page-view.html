<dom-module id="sr-add-page-view">
  <template>
    <style include="shared-styles">
      .top-padded {
        margin-top: 20px;
      }

      paper-radio-group {
        margin: 20px;
      }
    </style>
    <app-route
        route="{{route}}"
        pattern="/:context"
        data="{{routeData}}"
        tail="{{subRoute}}"></app-route>
    <template is="dom-if" if="[[showView]]">
      <paper-radio-group selected="{{creationAction}}">
        <paper-radio-button name="link">Bind to an existing page</paper-radio-button>
        <paper-radio-button name="new">Create a new page</paper-radio-button>
      </paper-radio-group>
      <template is="dom-if" if="[[shouldCreateNewPage(creationAction)]]">
        <paper-card>
          <app-toolbar>
            <div main-title>Create a new page</div>
          </app-toolbar>
          <div class="card-content">
            <paper-dropdown-menu label="Page Type">
              <paper-listbox slot="dropdown-content" class="dropdown-content">
                <template is="dom-repeat" items="{{pageTypes}}">
                  <paper-item>{{item}}</paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu>
            <paper-input
                label="New Page Title"
                required></paper-input>
            <paper-textarea label="Summary"></paper-textarea>
          </div>
          <div class="card-actions">
            <paper-toggle-button
                class="top-padded"
                checked="{{linkToPreviousPage}}">Link to previous page</paper-toggle-button>
            <paper-autocomplete
                label="Linked Page"
                source="[[linkedPageSources]]"
                required
                text="{{linkedPageText}}"
                value="{{linkedPageValue}}"
                disabled="[[linkToPreviousPage]]"
                show-results-on-focus></paper-autocomplete>
          </div>
        </paper-card>
      </template>
      <template is="dom-if" if="[[!shouldCreateNewPage(creationAction)]]">
        <paper-card>
          <app-toolbar>
            <div main-title>Bind to an existing page</div>
          </app-toolbar>
          <div class="card-content">
            <paper-autocomplete
                id="pageSearchInput"
                label="Search for Page"
                required
                source="[[titleSearches]]"
                text="{{searchPageText}}"
                show-results-on-focus></paper-autocomplete>
          </div>
        </paper-card>
      </template>
    </template>
    <iron-ajax
        id="getSearchPageResultsAjax"
        url="http://localhost:4000/user/page/search"
        handle-as="json"
        on-response="handleSearchPageResults"
        debounce-duration="300"></iron-ajax>
  </template>

  <script>
    class SrAddPageView extends Polymer.Element {
      static get is() { return 'sr-add-page-view'; }

      static get properties() {
        return {
          titleSearches: {
            type: Array,
            value: []
          },
          linkedPageSources: {
            type: Array,
            value: []
          },
          linkToPreviousPage: {
            type: Boolean,
            value: true
          },
          linkedPageText: {
            type: String,
            value: null
          },
          linkedPageValue: {
            type: String,
            value: null
          },
          pageTypes: {
            type: Array,
            value: []
          },
          creationAction: {
            type: String,
            value: 'link'
          },
          searchPageText: {
            type: String,
            value: null
          },
          searchPageParams: {
            type: Object,
            value: {}
          },
          showView: Boolean
        };
      }

      static get observers() {
        return [
          '_linkToPreviousPageChanged(linkToPreviousPage)',
          '_searchPageTextChanged(searchPageText)',
          '_routeDataChanged(routeData)',
        ];
      }

      constructor() {
        super();
        this._setLinkedPageDefaults();
        this._setPageTypes();
        // this.$.pageSearchInput.queryFn = this.searchQueryResults;
        // var newSearch = this.searchQueryResults();
        // this.set('titleSearches', newSearch);
      }

      _routeDataChanged(routeData) {
        var context = routeData.context;
        // console.log('Add Page');
        // console.log(this.route);
        // console.log(this.subRoute);
        // console.log(this.contextItem);
        this.set('hasContextItem', !!this.contextItem);
        this.set('showView', context == 'add-page');
      }

      _setComponentProperties() {
        var pageSearchInput = this.shadowRoot.querySelector("#pageSearchInput");
        pageSearchInput.queryFn = this.searchQueryResults;
      }

      _searchPageTextChanged(searchPageText) {
        this._retrieveTitlePageSearchResults(searchPageText);
      }

      _retrieveTitlePageSearchResults(searchQuery) {
        if (!searchQuery || searchQuery.length < 2) {
          this.set('titleSearches', []);
          return;
        }
        this._setComponentProperties();
        var params = {
          query: searchQuery,
          type: 'CH'
        };
        this.set('searchPageParams', params);
        this.$.getSearchPageResultsAjax.params = params;
        this.$.getSearchPageResultsAjax.generateRequest();
      }

      handleSearchPageResults(event) {
        var searchResults = [];
        event.detail.response.forEach(function(result) {
          searchResults.push({
            text: result.name,
            value: result.id
          });
        });
        this.set('titleSearches', searchResults);
      }

      shouldCreateNewPage(creationAction) {
        return creationAction == 'new';
      }

      _linkToPreviousPageChanged(linkToPreviousPage) {
        if (linkToPreviousPage) {
          this._setLinkedPageDefaults();
        }
      }

      _setLinkedPageDefaults() {
        this.set('linkedPageText', this.page.name);
        this.set('linkedPageValue', this.page.id);
      }

      _setPageTypes() {
        this.set('pageTypes', [
          'Association',
          'Campaign',
          'Character',
          'District',
          'Era',
          'Event',
          'Group',
          'History',
          'Item',
          'Landmark',
          'Lore',
          'Place',
          'Quest',
          'Race',
          'Region',
          'Report',
          'Section',
          'Set',
          'Species',
          'Story arc',
          'Taxon',
          'World',
        ]);
      }

      searchQueryResults(backEndResults, query) {
        console.log(query);
        return backEndResults;
      }
    }

    window.customElements.define(SrAddPageView.is, SrAddPageView);
  </script>
</dom-module>
