<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../page/sr-image.html">
<link rel="import" href="../page/sr-detail.html">
<link rel="import" href="../page/sr-related-pages.html">

<link rel="import" href="../shared-styles.html">

<dom-module id="sr-page-relation-view">
  <template>
    <style include="shared-styles">
      .related-pages {
        margin-top: 20px;
      }
    </style>
    <app-route
        route="{{route}}"
        pattern="/:context"
        data="{{routeData}}"></app-route>
    <template is="dom-if" if="contextGroup">
      <template is="dom-repeat" items="{{contextGroup.list}}">
        <sr-image
            context-item="[[item]]"
            context-index="[[index]]"
            route="[[route]]"></sr-image>
        <sr-detail
            context-item="[[item]]"
            context-index="[[index]]"
            route="[[route]]"></sr-detail>
        <sr-related-pages
            context-item="[[item]]"
            context-index="[[index]]"
            route="[[route]]"></sr-related-pages>
      </template>
      <template is="dom-if" if="{{!hasContextList(contextGroup)}}">
        <sr-image route="[[route]]"></sr-image>
        <sr-detail route="[[route]]"></sr-detail>
        <!-- normally impossible to reach, but possible if all related pages were deleted from the related-pages-view -->
        <sr-related-pages route="[[route]]"></sr-related-pages>
      </template>
    </template>
  </template>
  <script>
    class SrPageRelationView extends Polymer.Element {
      static get is() { return 'sr-page-relation-view'; }

      static get properties() {
        return {
          contextGroup: {
            type: Object
          }
        };
      }

      static get observers() {
        return [
          '_routeDataChanged(routeData)',
        ];
      }

      hasContextList(contextGroup) {
        return contextGroup && contextGroup.list && contextGroup.list.length;
      }

      _routeDataChanged(routeData) {
        var context = routeData.context;
        this._updateContextedItem(context);
      }

      _updateContextedItem(context) {
        if (context == 'detail') {
          return this._updateItemToDetails();
        }
        if (context == 'image') {
          return this._updateItemToImages();
        }
        if (context == 'related-pages') {
          return this._updateItemToRelatedPage();
        }
        return this._usetItem();
      }

      _updateItemToDetails() {
        this.set('contextGroup', this.page.details);
      }

      _updateItemToImages() {
        this.set('contextGroup', this.page.images);
      }

      _updateItemToRelatedPage() {
        var pathParts = this.route.path.split('/');
        var relatedPageType = pathParts[pathParts.length - 1];
        this.set('contextGroup', this._getRelatedPages(relatedPageType));
      }

      _getRelatedPages(relatedPageType) {
        var i;
        if (!this.page.pages) {
          return null;
        }
        for (i = 0; i < this.page.pages.length; i++) {
          if (this.page.pages[i].type == relatedPageType) {
            return this.page.pages[i].properties;
          }
        }
        return null;
      }

      _usetItem() {
        this.set('contextGroup', null);
      }
    }

    window.customElements.define(SrPageRelationView.is, SrPageRelationView);
  </script>
</dom-module>
